# CH5　ソフトウェアで表現されたモデル

- オブジェクト間の関連を設計して無駄をなくす

- モデルを表現する3パターンの要素
    - エンティティ
    - 値オブジェクト
    - サービス
- モジュール（パッケージ）はモデルの一部であり、ドメインにある概念を反映していなければならない

- これらの要素をドメイン駆動設計の文脈で捉えることによって、開発者は詳細なコンポーネントを作成しやすくなる

---
### 関連
- 現実の世界では、多対多の関連がたくさんあり、その多くは元々双方向である
    - 双方向のままモデル化すると、一般的な関連のせいで実装と保守が複雑になる

- 関連をもっと扱いやすくするには、少なくとも3つの方法がある
    1. 関連をたどる方向を強制する
    1. 限定子を付加して、多重度を効果的に減らす
    1. 本質的ではない関連を除去する

- 双方向の関連があるということは、両方のオブジェクトが一緒になった時にしか理解できないということを意味している

- 一方向にだけ辿るようにすることで、相互依存関係が減り、設計がシンプルになる

- それだけでなく、残された双方向の関連にも、関係が双方向であることがセマンティックな特徴となり、意味が与えられる

---
### エンティティ（Entity）
- **同一性**によって定義されるオブジェクトはエンティティと呼ばれる

- 同一性は「追跡」ができることである

- オブジェクトモデリングを行うと、オブジェクトの属性に集中しがちだが、エンティティの根本的な概念は抽象的な連続性である

- 時間が経っても、異なるかたちで表現されても変わらない同一性を表現しているオブジェクトは、属性が異なったとしても、他のオブジェクトと一致しなければならないことがある。
- 同じ属性を持ったオブジェクト同士だとしても、それぞれのオブジェクトが同一性を持っているのであれば、区別しなければならない

- 同一性とは何か
    - 例）現在の私と5歳の時の私は同一人物か？

- アプリケーションのユーザにとって重要な区別が属性から独立してなされるものは全てエンティティ
    - 例）人、都市、自動車、宝くじ、銀行取引

- **一意の識別子**を用いることで、同一性を表現できる

- **重要なのは、同一性に関する関心が、モデルの側面を軸にしているということを認識することである**
    - 見方によっては、そのオブジェクトは同一性を持たないかもしれない

- そのため、同一性を割り当てる操作は人の手による人力を伴うことが多い。
    - 小切手帳の照合をするソフトウェアは候補になりそうなものを提供はしても、最終判断はユーザが行うことになっている（）
---


### 値オブジェクト（VALUE OBJECTS）

- 全てのオブジェクトに対して人工的な同一性を与えると、全ての追跡に対処しなければならず分析作業が増え、すべてのオブジェクトの見た目が同じになってしまうことでモデルが台無しになりかねない
    - 見た目が同じだとしても同一性が与えられているため区別出来てしまうから

- 値オブジェクトは**物事を記述するオブジェクト**である
    - ドメインにおける記述的な側面を表現し、概念的な同一性を持たない
    - 値オブジェクトが表現しようとするのは**何があるか**だけが問題であり、<br>
      **誰であるか**、あるいは**どれであるか**は問われないような設計の要素である

- 値オブジェクトは何か　例）
    - 手書きの絵・・・エンティティ
    - 使った赤色のペン・・・値オブジェクト

- 値オブジェクトに自分が伝える属性の意味を表現させ、関係した機能を与えること
- 値オブジェクトを**不変なもの**として扱うこと

- 値オブジェクトを構成する属性は、概念的な統一体を形成すべきである
    - 住所はエンティティ（住所は変わるが同一性を持つ）だが、<br>
      街区、都市、郵便番号は住所全体の一部であり、値オブジェクトである

- 値オブジェクトは不変でなければならないため、エンティティの持つ値オブジェクトを変更したい場合、完全に置き換える以外、変更はできないようにすることでオブジェクトを安全に保つ

- ドメインモデルとしても値オブジェクトの変更は完全な置き換えが納得できるかもしれない

- 値オブジェクトは何か　例）
    - 手書きの絵・・・エンティティ
    - 使った赤色のペン・・・値オブジェクト
    - 使っている赤色のペンを青色に変える・・・赤色のペンを捨てて青色のペンを持つ（値オブジェクトの置き換え）

- 現実の行為と整合性が取れている=ドメインとして正しいふるまい（？）


### サービス（SERVICE）
-   ドメインの重要な操作でありながら、エンティティにも値オブジェクトにも自然な落ち着き場所を見つけることのできないもの

-   サービスは「実行者」である

-   サービスは、エンティティや値オブジェクトと異なり、純粋にクライアントに対して何が実行できるかという観点から定義される

-   実態よりも活動、名詞よりも動詞にちなんで命名される傾向がある

-   サービスはエンティティと値オブジェクトから全てのふるまいを奪ってはならない

- 優れたサービスには3つの特徴がある
    - 操作がドメインの概念に関係しており、その概念がエンティティや値オブジェクトの一部ではない
    - ドメインモデルの他の要素の観点からインタフェースが定義されている
    - 操作に状態が無い（捜査対象の個々の履歴を気にする必要は無い）

- 多くのドメインサービスやアプリケーションサービスは、エンティティと値オブジェクトで構成される集合体の上に構築され、ドメインに本来備わっている能力をまとめ上げて、**実際に何らかの処理を行うスクリプトのようにふるまう**

- アプリケーションサービスとドメインサービス、インフラストラクチャサービスに分割できる
    - アプリケーションサービス
        - 操作対象がそのドメインにおいて意味がなく、ビジネスルールが関係していない
    - ドメインサービス
        - ドメインにおいて意味があり、ビジネスルールが関係している

    - インフラストラクチャサービス
        - 純粋に技術的な操作

---

### モジュール[パッケージ]（MODULE/PACKAGE）
- 適切なモジュールによって、全体によって圧倒されることなくモジュール内部の詳細を見ることができる
- また内部の詳細を無視した上で、モジュール間の関係性を見ることができる

- ドメイン層のモジュールは、モデルにおいて意味のある一部として現れ、より大きな尺度でドメインの事を語らなければならない

- **モジュール間では低結合、モジュール内では高凝集**

- モジュールに分割されるのではコードだけではなく、概念も分割される

- ドメイン駆動設計にある他のパターンと同じく、モジュールも**コミュニケーションの仕組み**である

- モデルが物語だとすれば、モジュールは章に相当する

- モジュールには、ユビキタス言語の一部になる名前をつけること
- モジュールとその名前はドメインに対する洞察を反映していなければならない

- モジュールをリファクタリングすることは、クラスをリファクタリングするよりも手間がかかり、混乱を招きもするため、それほど頻繁に行うことはできない（しにくい）

- 初期のモジュールの選択によって後にモジュール間が高結合につながり、それによってリファクタリングが困難になることがある
- こうしたことを克服するためには、**歯を食いしばってモジュールを再構成するしかない**

- インフラストラクチャ駆動パッケージング
    - 技術的なフレームワークによってパッケージングの決定を強制する
    - 有効な例）レイヤ化アーキテクチャ（論理階層による分断）
        - ドメイン層を物理的に分離してそれ自身のパッケージに残す

    - 阻止しなければいけない例）ティア化アーキテクチャ（物理階層による分断）
        - 責務が断片化された状態のこと
        - モデルオブジェクトの実務が断片化されるかもしれない
        - 例えば「データ永続化層」「アプリケーション特有の機能層」・・・層ごとでモデルオブジェクトを持つ

- 単一の概念オブジェクトを実装するコードは全て、同一のオブジェクトにならなくても、同一のモジュールにまとめること

- モジュール性は設計が大きく複雑になるにつれて、ますます重要になる


---

### モデリングパラダイム
- 現在の主流はオブジェクト指向設計

- なぜオブジェクトパラダイムが主流なのか？
    - シンプルでありながら洗練されている
    - オブジェクト指向設計の基本は、たいていの人にとって自然に見えるようだ
    - 技術者ではなくてもオブジェクトモデルの図を理解することはできる
    - **開発者コミュニティと設計文化そのものが成熟している**

- オブジェクトの世界におけるオブジェクトでないもの
    - 最も一般的な例が「関係データベース」

- オブジェクト指向が主流となっているシステムに、非オブジェクトの要素を混ぜ合わせる時に気を付けること
    - 実装パラダイムと対立しないこと
        - パラダイムに合うモデルの概念を見つける
    - ユビキタス言語に頼ること
        - 言語を一貫して使用すれば、設計の各部分が分かれていってしまうことはない
    - UMLにこだわらないこと
        - ツールに固執することで、容易に描けるものに合わせてモデルが歪められることがある
    - 懐疑的であること
        - ツールは本当に相応の働きをしているのか？

---
## 議論したいこと



## 伊藤気になった点
- アプリケーションサービスとドメインサービスの分割が具体的にイメージしにくい
