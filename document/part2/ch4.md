# CH4　ドメインを隔離する

- ドメインオブジェクトはシステムの他の機能から切り離す必要がある
- ソフトウェアの技術にしか関係しない概念と混同することを避ける
    - 分離を行うために洗練された技術が、レイヤ化アーキテクチャ

---
### レイヤ化アーキテクチャ（LAYERED ARCHITECTURE）
- レイヤ
    - ユーザインタフェース
    - アプリケーション
    - **ドメイン**
    - インフラストラクチャ
- UI や DB の処理がビジネスオブジェクトに書かれることがしばしばある
    - 短期的には、動くすようにするには最も簡単だから
    - コードから意味を追うのが困難になる
    - ビジネスルールを変更するために、UI や DB のコードを丹念に追跡しなければならない
- レイヤ内のどの要素も、**同じレイヤの他の要素か、その「下にある」レイヤの要素にしか依存しない**
- DDD 的には、**ドメイン層が分離されること**が MUST

#### レイヤを関係付ける
- レイヤ同士は疎結合であるべき、設計の依存関係は１方向
    - 上位レイヤは、下位レイヤにある要素を直接使用したり操作したりできる
    - 下位レイヤが上方と通信しなければならない場合、コールバックやオブザーバなどのパターンを使う
- UI <-> アプリケーション層、ドメイン層
    - 父祖が MVC
    - 他にも方法はあるが、ドメイン層を隔離できるならどのアプローチでも構わない
- ドメイン <-> インフラストラクチャ層
    - インフラストラクチャ層は、ドメインの知識を持ってはならない
    - ドメインは、**いつ**インフラ（例：メール送信）を呼び出すかは知っているが、**どのように**メール送信をするかまでは背負い込まないようにする
- すべてのインフラストラクチャが、上位レイヤから呼び出せるサービスの形になっているとは限らない
    - 他のレイヤの基本的な機能を直接支援する（すべてのドメインオブジェクトに抽象基底クラスを提供するなど）
    - 他のレイヤを関係付けるための仕組み（MVC の実装など）
    - ↑アーキテクチャフレームワーク

#### アーキテクチャフレームワーク
- インフラストラクチャの要求を統合するフレームワークを使うと、他のレイヤをきわめて特殊な仕方で実装しなければならなくなることも多い
    - 例：
        - フレームワークが定義したクラスのサブクラスとして実装
        - メソッドシグネチャを規定
- アーキテクチャフレームワークは複雑な技術的問題を解決し、ドメイン開発者がモデルに集中できるようにする
- 一方で、以下のような開発の妨げにもなりうる
    - ドメインについての設計の選択肢を制限する
    - 実装を重苦しくしてしまったりする
    - 例：初期の J2EE アプリケーションはすべてのドメインオブジェクトを「エンティティ Bean」として実装
- 万能のフレームワークを探すのではなく、難しい問題を解決するために、**必要なものだけを選んで適用するべき**
- 技術的な解決策に熱中しすぎないよう注意

---
### ドメイン層はモデルが息づく場所
- ドメインの実装を隔離することは、ドメイン駆動設計の必要条件

#### 利口な UI「アンチパターン」（SMART UI "ANTI-PATTERN"）
- ドメイン駆動設計とは正反対のパターン
- すべてのビジネスロジックを UI に入れる
- データベースをデータの共有リポジトリとして使用する
- 利点
    - 単純なアプリケーションの場合すぐに作れる
    - 有能な開発者でなくても可能
    - 単純な振る舞いを付け加える拡張なら容易
- 欠点
    - アプリケーションの統合は困難
    - ふるまいの再利用、ビジネス問題の抽象化は行われず、コピペ
    - 豊かなふるまいをするような変更は困難
- （不必要に高度な設計アプローチに手を出すのはよくある間違いではある）
- 利口な UI は、別の設計アプローチに移行する際には、すべて置き換えるしかなくなる
- 継続的なイテレーションを通じてより豊かな機能を構築していかなければならないなら、ドメインレイヤを隔離したモデル駆動でなければ行き詰まる
- 利口な UI とレイヤ化アーキテクチャとの中間の例として、トランザクションスクリプト
    - UI をアプリから分離はするが、オブジェクトモデルは提供しない



---
## 議論したいこと
- もしかしたら、この章で話すべき内容ではないかも…。
    - REST APIはドメイン単位で取るべき？
    - GRAPH QL はドメイン単位？それとも、ドメインの持つ項目単位？
    - マイクロサービス化する際には、どのような切り方を目指すべき？巨大なドメイン？

## 以下高木気になった点
- ap層の責務について、具体的なコードレベルで知りたい（以下が知りたい）
    - 正しいIF
    - フェイクオブジェクト？
    - ビジネスユースケースごとにクラスを切る感じか？
- 利口なUIの欠点でデータベースによる統合が挙げられていたが、具体的にデータベースによる統合でどんな悪いことがあるのか
  （DOAは思想的に間違っているのか？、今はマイクロサービスが流行っているが関係あるか？）

## 鈴木気になった点
- 「ユーザインタフェース層とアプリケーション層を区別しないこともある」
- 凹型レイヤはコンパイル時はインフラストラクチャがドメインに依存しているが、実行時の依存関係とは別の話？
    - dependency inversion principle

